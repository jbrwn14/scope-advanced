<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scope Pro - Advanced Construction Quoting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .room-box {
            border: 2px solid #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            margin: 5px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .room-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
        .room-overlay {
            position: absolute;
            border: 2px solid;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            cursor: move;
            transition: all 0.3s ease;
            min-width: 40px;
            min-height: 30px;
            user-select: none;
        }
        .room-overlay:hover {
            transform: scale(1.05);
            z-index: 10;
        }
        .trade-btn.active {
            background: #3b82f6;
            color: white;
        }
        .price-book-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .price-book-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .price-book-card.active {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.05);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-900">üèóÔ∏è Scope Pro</h1>
                <div class="flex items-center space-x-4">
                    <button onclick="showPriceBooks()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        üí∞ Price Books
                    </button>
                    <button onclick="saveProject()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                        üíæ Save Project
                    </button>
                    <div class="text-xl font-bold text-blue-600">Scope. Quote. Win.</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Column 1: File Upload -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">1. Upload Floor Plan</h2>
                
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-4">
                    <input type="file" id="fileInput" accept="image/*" class="hidden">
                    <button onclick="uploadFile()" class="bg-blue-600 text-white px-4 py-2 rounded mb-4 hover:bg-blue-700">
                        üìÅ Upload Image
                    </button>
                    <p class="text-gray-600">Upload a floor plan image</p>
                </div>

                <div id="filePreview" class="hidden mb-4">
                    <img id="previewImage" class="w-full rounded border mb-2">
                    <p id="fileName" class="text-sm text-gray-600"></p>
                    <button onclick="removeFile()" class="text-red-600 hover:text-red-800 text-sm">
                        üóëÔ∏è Remove File
                    </button>
                </div>

                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold text-blue-900 mb-3">üîç Floor Plan Analysis</h4>
                    <button onclick="analyzeFloorPlan()" class="w-full bg-blue-600 text-white py-2 rounded mb-2 hover:bg-blue-700">
                        üéØ Analyze Floor Plan
                    </button>
                    <button onclick="addSampleRooms()" class="w-full bg-gray-600 text-white py-2 rounded hover:bg-gray-700">
                        üè† Add Sample Rooms
                    </button>
                </div>

                <div class="space-y-3">
                    <input type="text" id="projectName" placeholder="Project Name" class="w-full px-3 py-2 border rounded">
                    <input type="text" id="customerName" placeholder="Customer Name" class="w-full px-3 py-2 border rounded">
                    <input type="text" id="projectAddress" placeholder="Project Address" class="w-full px-3 py-2 border rounded">
                </div>
            </div>

            <!-- Column 2: Rooms & Visualization -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">2. Project Rooms & Zones</h2>
                
                <div id="roomEditor" class="bg-gray-100 rounded-lg h-64 relative mb-4 overflow-hidden border-2 border-dashed border-gray-300">
                    <div class="absolute inset-0 flex items-center justify-center text-gray-500">
                        <div class="text-center">
                            <i class="text-4xl mb-2">üè†</i>
                            <div class="text-sm mb-2">Room visualization area</div>
                            <div class="text-xs text-gray-400">Upload floor plan or add sample rooms</div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Highlight by Trade:</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="highlightTrade('electrical')" class="trade-btn px-3 py-2 text-sm border rounded hover:bg-blue-50" data-trade="electrical">
                            üí° Electrical
                        </button>
                        <button onclick="highlightTrade('plumbing')" class="trade-btn px-3 py-2 text-sm border rounded hover:bg-green-50" data-trade="plumbing">
                            üö∞ Plumbing
                        </button>
                        <button onclick="highlightTrade('hvac')" class="trade-btn px-3 py-2 text-sm border rounded hover:bg-red-50" data-trade="hvac">
                            üå°Ô∏è HVAC
                        </button>
                        <button onclick="highlightTrade('flooring')" class="trade-btn px-3 py-2 text-sm border rounded hover:bg-yellow-50" data-trade="flooring">
                            üè† Flooring
                        </button>
                    </div>
                </div>
                
                <div id="roomsList" class="mb-4 max-h-48 overflow-y-auto">
                    <p class="text-gray-500">No rooms added yet</p>
                </div>

                <div class="space-y-2">
                    <button onclick="addRoom()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
                        ‚ûï Add Room Manually
                    </button>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="clearAllRooms()" class="bg-red-600 text-white py-2 rounded text-sm hover:bg-red-700">
                            üóëÔ∏è Clear All
                        </button>
                        <button onclick="showRoomDetails()" class="bg-purple-600 text-white py-2 rounded text-sm hover:bg-purple-700">
                            ‚öôÔ∏è Room Details
                        </button>
                    </div>
                </div>
            </div>

            <!-- Column 3: Costs -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">3. Cost Calculation</h2>
                
                <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-medium text-blue-900" id="currentPriceBook">Standard Materials</p>
                            <p class="text-xs text-blue-700">Click to change price book</p>
                        </div>
                        <button onclick="showPriceBooks()" class="text-blue-600 hover:text-blue-800">
                            üìù Change
                        </button>
                    </div>
                </div>

                <!-- Cost View Toggle -->
                <div class="mb-4">
                    <div class="flex bg-gray-100 rounded-lg p-1">
                        <button id="tradeViewBtn" onclick="toggleCostView('trade')" class="flex-1 py-2 px-3 text-sm rounded-md bg-blue-600 text-white">
                            By Trade
                        </button>
                        <button id="roomViewBtn" onclick="toggleCostView('room')" class="flex-1 py-2 px-3 text-sm rounded-md text-gray-600 hover:text-gray-800">
                            By Room
                        </button>
                    </div>
                </div>

                <div id="costBreakdown" class="mb-4">
                    <p class="text-gray-500">Add rooms to see costs</p>
                </div>

                <div class="space-y-3 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Labor Rate ($/hour)</label>
                        <input type="number" id="laborRate" value="85" onchange="updateCosts()" class="w-full px-3 py-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Markup %</label>
                        <input type="number" id="markupPercent" value="25" onchange="updateCosts()" class="w-full px-3 py-2 border rounded">
                    </div>
                </div>

                <div class="border-t pt-4 mb-4">
                    <div class="flex justify-between text-lg font-bold">
                        <span>Total:</span>
                        <span id="totalCost" class="text-blue-600">$0</span>
                    </div>
                    <div class="text-sm text-gray-600">
                        Rooms: <span id="roomCount">0</span>
                    </div>
                </div>

                <div class="space-y-2">
                    <button onclick="generateQuote()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">
                        üìÑ Generate Quote PDF
                    </button>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="showCostBreakdown()" class="bg-blue-600 text-white py-2 rounded text-sm hover:bg-blue-700">
                            üìä Cost Details
                        </button>
                        <button onclick="presentToCustomer()" class="bg-purple-600 text-white py-2 rounded text-sm hover:bg-purple-700">
                            üë• Present
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Price Books Modal -->
    <div id="priceBookModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">üí∞ Price Book Manager</h2>
                        <button onclick="closePriceBooks()" class="text-gray-500 hover:text-gray-700 text-2xl">
                            &times;
                        </button>
                    </div>

                    <!-- Price Book Selection -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-4">Select Active Price Book:</h3>
                        <div id="priceBookCards" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Cards will be populated here -->
                        </div>
                    </div>

                    <!-- Current Price Book Items -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-4">Current Price Book Items:</h3>
                        <div id="priceBookItems">
                            <!-- Items will be populated here -->
                        </div>
                    </div>

                    <!-- Add New Item -->
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-medium mb-3">Add New Item</h4>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <select id="newItemTrade" class="px-3 py-2 border rounded">
                                <option value="electrical">Electrical</option>
                                <option value="plumbing">Plumbing</option>
                                <option value="hvac">HVAC</option>
                                <option value="flooring">Flooring</option>
                            </select>
                            <input type="text" id="newItemName" placeholder="Item Name" class="px-3 py-2 border rounded">
                            <input type="number" id="newItemCost" placeholder="Cost ($)" step="0.01" class="px-3 py-2 border rounded">
                            <input type="text" id="newItemUnit" placeholder="Unit" class="px-3 py-2 border rounded">
                            <button onclick="addNewItem()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                Add Item
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let rooms = [];
        let roomIdCounter = 1;
        let selectedTrade = null;
        let uploadedImage = null;
        let currentPriceBookId = 1;
        let costViewMode = 'trade'; // 'trade' or 'room'

        // Price books data
        let priceBooks = [
            {
                id: 1,
                name: 'Standard Materials',
                description: 'Basic construction materials',
                active: true,
                multiplier: 1.0,
                items: {
                    electrical: [
                        { name: '15A GFCI Outlet', cost: 12.50, unit: 'ea' },
                        { name: 'LED Recessed Light 6"', cost: 45.00, unit: 'ea' },
                        { name: '12-2 Romex Wire', cost: 1.25, unit: 'ft' }
                    ],
                    plumbing: [
                        { name: 'Kitchen Sink Faucet', cost: 125.00, unit: 'ea' },
                        { name: '1/2" Copper Pipe', cost: 3.50, unit: 'ft' },
                        { name: 'Toilet - Standard', cost: 180.00, unit: 'ea' }
                    ],
                    hvac: [
                        { name: 'Ductwork 6" Round', cost: 12.00, unit: 'ft' },
                        { name: 'Register 6x10', cost: 25.00, unit: 'ea' }
                    ],
                    flooring: [
                        { name: 'Hardwood Oak 3/4"', cost: 8.50, unit: 'sq ft' },
                        { name: 'Vinyl Plank Premium', cost: 4.25, unit: 'sq ft' }
                    ]
                }
            },
            {
                id: 2,
                name: 'Premium Line',
                description: 'High-end materials',
                active: false,
                multiplier: 1.4,
                items: {
                    electrical: [
                        { name: 'Designer GFCI Outlet', cost: 25.00, unit: 'ea' },
                        { name: 'Smart LED Light', cost: 85.00, unit: 'ea' }
                    ],
                    plumbing: [
                        { name: 'Premium Kitchen Faucet', cost: 350.00, unit: 'ea' }
                    ],
                    hvac: [
                        { name: 'Premium Ductwork', cost: 18.00, unit: 'ft' }
                    ],
                    flooring: [
                        { name: 'Luxury Vinyl Plank', cost: 12.00, unit: 'sq ft' }
                    ]
                }
            },
            {
                id: 3,
                name: 'Budget Option',
                description: 'Cost-effective materials',
                active: false,
                multiplier: 0.7,
                items: {
                    electrical: [
                        { name: 'Basic Outlet', cost: 8.00, unit: 'ea' },
                        { name: 'CFL Light Fixture', cost: 25.00, unit: 'ea' }
                    ],
                    plumbing: [
                        { name: 'Basic Kitchen Faucet', cost: 75.00, unit: 'ea' }
                    ],
                    hvac: [
                        { name: 'Basic Ductwork', cost: 8.00, unit: 'ft' }
                    ],
                    flooring: [
                        { name: 'Laminate Flooring', cost: 3.50, unit: 'sq ft' }
                    ]
                }
            }
        ];

        // File upload function
        function uploadFile() {
            document.getElementById('fileInput').click();
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const preview = document.getElementById('filePreview');
            const previewImage = document.getElementById('previewImage');
            const fileName = document.getElementById('fileName');

            fileName.textContent = file.name;
            preview.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                uploadedImage = e.target.result;
                updateRoomEditor();
                alert('‚úÖ Floor plan uploaded successfully!');
            };
            reader.readAsDataURL(file);
        });

        function removeFile() {
            uploadedImage = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('filePreview').classList.add('hidden');
            updateRoomEditor();
            alert('üóëÔ∏è File removed');
        }

        // Analyze floor plan
        function analyzeFloorPlan() {
            if (!uploadedImage) {
                alert('‚ùå Please upload a floor plan first');
                return;
            }
            
            alert('üîÑ Analyzing floor plan...');
            
            setTimeout(() => {
                addSampleRooms();
                alert('‚úÖ Analysis complete! Found 6 rooms in your floor plan.');
            }, 1000);
        }

        // Add sample rooms
        function addSampleRooms() {
            rooms = [
                { id: 1, name: 'Living Room', area: 280, type: 'living', trades: ['electrical', 'flooring'] },
                { id: 2, name: 'Kitchen', area: 160, type: 'kitchen', trades: ['electrical', 'plumbing'] },
                { id: 3, name: 'Dining Room', area: 140, type: 'dining', trades: ['electrical', 'flooring'] },
                { id: 4, name: 'Master Bedroom', area: 220, type: 'bedroom', trades: ['electrical', 'flooring'] },
                { id: 5, name: 'Bathroom', area: 65, type: 'bathroom', trades: ['electrical', 'plumbing', 'hvac'] },
                { id: 6, name: 'Garage', area: 350, type: 'garage', trades: ['electrical'] }
            ];
            roomIdCounter = 7;
            updateRoomsList();
            updateRoomEditor();
            updateCosts();
            alert('üè† 6 sample rooms added to project!');
        }

        // Add room manually
        function addRoom() {
            const name = prompt('Room name:', 'New Room');
            if (!name) return;

            const area = prompt('Room area (sq ft):', '150');
            if (!area || isNaN(area)) return;

            const room = {
                id: roomIdCounter++,
                name: name,
                area: parseInt(area),
                type: 'living',
                trades: ['electrical']
            };

            rooms.push(room);
            updateRoomsList();
            updateRoomEditor();
            updateCosts();
            alert(`‚úÖ ${name} added to project!`);
        }

        // Clear all rooms
        function clearAllRooms() {
            if (confirm('üóëÔ∏è Clear all rooms?')) {
                rooms = [];
                roomIdCounter = 1;
                updateRoomsList();
                updateRoomEditor();
                updateCosts();
                alert('‚úÖ All rooms cleared');
            }
        }

        // Update room list display
        function updateRoomsList() {
            const roomsList = document.getElementById('roomsList');
            
            if (rooms.length === 0) {
                roomsList.innerHTML = '<p class="text-gray-500">No rooms added yet</p>';
                return;
            }

            roomsList.innerHTML = rooms.map(room => `
                <div class="room-box" onclick="editRoom(${room.id})">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-medium">${room.name}</div>
                            <div class="text-sm text-gray-600">${room.area} sq ft</div>
                            <div class="text-xs text-blue-600">${room.trades.join(', ')}</div>
                        </div>
                        <button onclick="event.stopPropagation(); deleteRoom(${room.id})" class="text-red-600 hover:text-red-800 text-sm">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Edit room
        function editRoom(roomId) {
            const room = rooms.find(r => r.id === roomId);
            if (!room) return;

            const newName = prompt('Room name:', room.name);
            if (newName) room.name = newName;

            const newArea = prompt('Room area (sq ft):', room.area);
            if (newArea && !isNaN(newArea)) room.area = parseInt(newArea);

            updateRoomsList();
            updateRoomEditor();
            updateCosts();
            alert(`‚úÖ ${room.name} updated`);
        }

        // Delete room
        function deleteRoom(roomId) {
            if (confirm('üóëÔ∏è Delete this room?')) {
                rooms = rooms.filter(r => r.id !== roomId);
                updateRoomsList();
                updateRoomEditor();
                updateCosts();
                alert('‚úÖ Room deleted');
            }
        }

        // Update room editor
        function updateRoomEditor() {
            const editor = document.getElementById('roomEditor');
            
            if (uploadedImage) {
                editor.style.backgroundImage = `url(${uploadedImage})`;
                editor.style.backgroundSize = 'contain';
                editor.style.backgroundRepeat = 'no-repeat';
                editor.style.backgroundPosition = 'center';
                editor.innerHTML = '';
                
                // Add room overlays
                rooms.forEach((room, index) => {
                    const roomDiv = document.createElement('div');
                    roomDiv.className = 'room-overlay';
                    roomDiv.onclick = () => editRoom(room.id);
                    
                    // Position rooms in a grid if no specific position
                    const x = 20 + (index % 3) * 80;
                    const y = 20 + Math.floor(index / 3) * 60;
                    
                    roomDiv.style.cssText = `
                        top: ${y}px;
                        left: ${x}px;
                        width: 60px;
                        height: 40px;
                        border-color: ${getRoomColor(room.type)};
                        background: ${getRoomColor(room.type)}80;
                    `;
                    
                    roomDiv.innerHTML = `
                        <div style="text-align: center; font-size: 10px; line-height: 1.2;">
                            ${room.name}<br>
                            <span style="font-size: 8px;">${room.area} sq ft</span>
                        </div>
                    `;
                    
                    editor.appendChild(roomDiv);
                });
            } else {
                editor.style.backgroundImage = 'none';
                editor.innerHTML = `
                    <div class="absolute inset-0 flex items-center justify-center text-gray-500">
                        <div class="text-center">
                            <div class="text-4xl mb-2">üè†</div>
                            <div class="text-sm mb-2">Room visualization area</div>
                            <div class="text-xs text-gray-400">Upload floor plan or add sample rooms</div>
                        </div>
                    </div>
                `;
            }
        }

        // Get room color
        function getRoomColor(type) {
            const colors = {
                living: '#3b82f6',
                kitchen: '#10b981',
                dining: '#f59e0b',
                bedroom: '#8b5cf6',
                bathroom: '#ef4444',
                garage: '#6b7280'
            };
            return colors[type] || '#3b82f6';
        }

        // Highlight trade
        function highlightTrade(trade) {
            // Reset all buttons
            document.querySelectorAll('.trade-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Activate clicked button
            const btn = document.querySelector(`[data-trade="${trade}"]`);
            if (btn) btn.classList.add('active');
            
            selectedTrade = selectedTrade === trade ? null : trade;
            alert(`üí° Highlighting ${trade} trade`);
        }

        // Toggle cost view
        function toggleCostView(mode) {
            costViewMode = mode;
            
            // Update button styles
            const tradeBtn = document.getElementById('tradeViewBtn');
            const roomBtn = document.getElementById('roomViewBtn');
            
            if (mode === 'trade') {
                tradeBtn.className = 'flex-1 py-2 px-3 text-sm rounded-md bg-blue-600 text-white';
                roomBtn.className = 'flex-1 py-2 px-3 text-sm rounded-md text-gray-600 hover:text-gray-800';
            } else {
                tradeBtn.className = 'flex-1 py-2 px-3 text-sm rounded-md text-gray-600 hover:text-gray-800';
                roomBtn.className = 'flex-1 py-2 px-3 text-sm rounded-md bg-blue-600 text-white';
            }
            
            updateCosts();
        }

        // Update costs
        function updateCosts() {
            const laborRate = parseFloat(document.getElementById('laborRate').value) || 85;
            const markupPercent = parseFloat(document.getElementById('markupPercent').value) || 25;
            const activeBook = priceBooks.find(book => book.active);
            const multiplier = activeBook ? activeBook.multiplier : 1.0;

            let totalCost = 0;
            const costsByTrade = {};
            const costsByRoom = {};

            rooms.forEach(room => {
                let roomTotal = 0;
                
                room.trades.forEach(trade => {
                    const items = activeBook?.items[trade] || [];
                    const avgCost = items.length > 0 ? 
                        items.reduce((sum, item) => sum + item.cost, 0) / items.length : 30;
                    
                    let cost = 0;
                    switch(trade) {
                        case 'flooring':
                            cost = room.area * avgCost * multiplier;
                            break;
                        case 'electrical':
                            cost = (room.area / 20) * avgCost * multiplier;
                            break;
                        case 'plumbing':
                            cost = (room.area / 50) * avgCost * multiplier;
                            break;
                        case 'hvac':
                            cost = (room.area / 30) * avgCost * multiplier;
                            break;
                        default:
                            cost = room.area * 5 * multiplier;
                    }
                    
                    const laborHours = cost / 100;
                    const laborCost = laborHours * laborRate;
                    const totalTradeCost = (cost + laborCost) * (1 + markupPercent / 100);
                    
                    if (!costsByTrade[trade]) costsByTrade[trade] = 0;
                    costsByTrade[trade] += totalTradeCost;
                    totalCost += totalTradeCost;
                    roomTotal += totalTradeCost;
                });
                
                costsByRoom[room.name] = roomTotal;
            });

            // Update display based on view mode
            const costBreakdown = document.getElementById('costBreakdown');
            if (rooms.length === 0) {
                costBreakdown.innerHTML = '<p class="text-gray-500">Add rooms to see costs</p>';
            } else {
                if (costViewMode === 'trade') {
                    costBreakdown.innerHTML = Object.entries(costsByTrade).map(([trade, cost]) => `
                        <div class="flex justify-between py-2 border-b">
                            <span class="capitalize font-medium">${trade}</span>
                            <span class="text-blue-600">${Math.round(cost).toLocaleString()}</span>
                        </div>
                    `).join('');
                } else {
                    costBreakdown.innerHTML = Object.entries(costsByRoom).map(([room, cost]) => `
                        <div class="flex justify-between py-2 border-b">
                            <span class="font-medium">${room}</span>
                            <span class="text-blue-600">${Math.round(cost).toLocaleString()}</span>
                        </div>
                    `).join('');
                }
            }

            document.getElementById('totalCost').textContent = `${Math.round(totalCost).toLocaleString()}`;
            document.getElementById('roomCount').textContent = rooms.length;
        }

        // Show price books
        function showPriceBooks() {
            document.getElementById('priceBookModal').classList.remove('hidden');
            updatePriceBookCards();
            updatePriceBookItems();
        }

        function closePriceBooks() {
            document.getElementById('priceBookModal').classList.add('hidden');
        }

        function updatePriceBookCards() {
            const container = document.getElementById('priceBookCards');
            container.innerHTML = priceBooks.map(book => `
                <div class="price-book-card p-4 border rounded-lg ${book.active ? 'active' : ''}" onclick="selectPriceBook(${book.id})">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-medium">${book.name}</h4>
                        ${book.active ? '<span class="text-green-600">‚úì Active</span>' : ''}
                    </div>
                    <p class="text-sm text-gray-600 mb-2">${book.description}</p>
                    <div class="text-xs text-gray-500">
                        Multiplier: ${book.multiplier}x
                    </div>
                </div>
            `).join('');
        }

        function selectPriceBook(bookId) {
            priceBooks.forEach(book => book.active = false);
            const selectedBook = priceBooks.find(book => book.id === bookId);
            if (selectedBook) {
                selectedBook.active = true;
                currentPriceBookId = bookId;
                document.getElementById('currentPriceBook').textContent = selectedBook.name;
                updatePriceBookCards();
                updatePriceBookItems();
                updateCosts();
                alert(`‚úÖ Price book changed to: ${selectedBook.name}`);
            }
        }

        function updatePriceBookItems() {
            const activeBook = priceBooks.find(book => book.active);
            const container = document.getElementById('priceBookItems');
            
            if (!activeBook) return;
            
            let html = '';
            Object.entries(activeBook.items).forEach(([trade, items]) => {
                html += `
                    <div class="mb-4">
                        <h4 class="font-medium text-gray-800 mb-2 capitalize">${trade}</h4>
                        <div class="space-y-2">
                            ${items.map((item, index) => `
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                    <div>
                                        <span class="font-medium">${item.name}</span>
                                        <span class="text-sm text-gray-600"> - $${item.cost} per ${item.unit}</span>
                                    </div>
                                    <button onclick="deleteItem('${trade}', ${index})" class="text-red-600 hover:text-red-800 text-sm">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function addNewItem() {
            const trade = document.getElementById('newItemTrade').value;
            const name = document.getElementById('newItemName').value;
            const cost = parseFloat(document.getElementById('newItemCost').value);
            const unit = document.getElementById('newItemUnit').value;

            if (!name || !cost || !unit) {
                alert('‚ùå Please fill in all fields');
                return;
            }

            const activeBook = priceBooks.find(book => book.active);
            if (activeBook) {
                if (!activeBook.items[trade]) {
                    activeBook.items[trade] = [];
                }
                
                activeBook.items[trade].push({
                    name: name,
                    cost: cost,
                    unit: unit
                });

                // Clear form
                document.getElementById('newItemName').value = '';
                document.getElementById('newItemCost').value = '';
                document.getElementById('newItemUnit').value = '';

                updatePriceBookItems();
                updateCosts();
                alert(`‚úÖ ${name} added to ${trade} section`);
            }
        }

        function deleteItem(trade, index) {
            if (confirm('üóëÔ∏è Delete this item?')) {
                const activeBook = priceBooks.find(book => book.active);
                if (activeBook && activeBook.items[trade]) {
                    activeBook.items[trade].splice(index, 1);
                    updatePriceBookItems();
                    updateCosts();
                    alert('‚úÖ Item deleted');
                }
            }
        }

        // Generate quote
        function generateQuote() {
            if (rooms.length === 0) {
                alert('‚ùå Please add rooms to generate a quote');
                return;
            }
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Header
                doc.setFontSize(20);
                doc.text('üèóÔ∏è Scope Pro - Construction Quote', 20, 20);
                
                // Project info
                doc.setFontSize(12);
                const projectName = document.getElementById('projectName').value || 'Untitled Project';
                const customerName = document.getElementById('customerName').value || 'Customer';
                const projectAddress = document.getElementById('projectAddress').value || 'Address';
                const laborRate = parseFloat(document.getElementById('laborRate').value) || 85;
                const markupPercent = parseFloat(document.getElementById('markupPercent').value) || 25;
                const activeBook = priceBooks.find(book => book.active);
                const multiplier = activeBook ? activeBook.multiplier : 1.0;
                
                doc.text(`Project: ${projectName}`, 20, 40);
                doc.text(`Customer: ${customerName}`, 20, 50);
                doc.text(`Address: ${projectAddress}`, 20, 60);
                doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 70);
                doc.text(`Price Book: ${activeBook?.name || 'Standard'} (${multiplier}x)`, 20, 80);
                doc.text(`Labor Rate: ${laborRate}/hr | Markup: ${markupPercent}%`, 20, 90);
                
                // Detailed Room Breakdown
                doc.setFontSize(14);
                doc.text('Detailed Cost Breakdown:', 20, 110);
                
                let yPos = 125;
                let grandTotal = 0;
                
                rooms.forEach((room, roomIndex) => {
                    // Check if we need a new page
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${roomIndex + 1}. ${room.name} (${room.area} sq ft)`, 25, yPos);
                    doc.setFont(undefined, 'normal');
                    yPos += 15;
                    
                    let roomTotal = 0;
                    
                    room.trades.forEach(trade => {
                        const items = activeBook?.items[trade] || [];
                        const avgCost = items.length > 0 ? 
                            items.reduce((sum, item) => sum + item.cost, 0) / items.length : 30;
                        
                        let cost = 0;
                        let description = '';
                        
                        switch(trade) {
                            case 'flooring':
                                cost = room.area * avgCost * multiplier;
                                description = `${room.area} sq ft √ó ${(avgCost * multiplier).toFixed(2)}`;
                                break;
                            case 'electrical':
                                cost = (room.area / 20) * avgCost * multiplier;
                                description = `${(room.area / 20).toFixed(1)} units √ó ${(avgCost * multiplier).toFixed(2)}`;
                                break;
                            case 'plumbing':
                                cost = (room.area / 50) * avgCost * multiplier;
                                description = `${(room.area / 50).toFixed(1)} units √ó ${(avgCost * multiplier).toFixed(2)}`;
                                break;
                            case 'hvac':
                                cost = (room.area / 30) * avgCost * multiplier;
                                description = `${(room.area / 30).toFixed(1)} units √ó ${(avgCost * multiplier).toFixed(2)}`;
                                break;
                            default:
                                cost = room.area * 5 * multiplier;
                                description = `${room.area} sq ft √ó ${(5 * multiplier).toFixed(2)}`;
                        }
                        
                        const laborHours = cost / 100;
                        const laborCost = laborHours * laborRate;
                        const totalTradeCost = (cost + laborCost) * (1 + markupPercent / 100);
                        
                        // Trade line
                        doc.text(`   ${trade.charAt(0).toUpperCase() + trade.slice(1)}: ${description}`, 30, yPos);
                        doc.text(`${cost.toFixed(0)}`, 160, yPos);
                        yPos += 10;
                        
                        // Labor line
                        doc.text(`   + Labor: ${laborHours.toFixed(1)} hrs √ó ${laborRate}`, 30, yPos);
                        doc.text(`${laborCost.toFixed(0)}`, 160, yPos);
                        yPos += 10;
                        
                        // Markup line
                        doc.text(`   + Markup: ${markupPercent}%`, 30, yPos);
                        doc.text(`${(totalTradeCost - cost - laborCost).toFixed(0)}`, 160, yPos);
                        yPos += 10;
                        
                        // Trade total
                        doc.setFont(undefined, 'bold');
                        doc.text(`   Trade Total:`, 30, yPos);
                        doc.text(`${totalTradeCost.toFixed(0)}`, 160, yPos);
                        doc.setFont(undefined, 'normal');
                        yPos += 15;
                        
                        roomTotal += totalTradeCost;
                    });
                    
                    // Room total
                    doc.setFont(undefined, 'bold');
                    doc.text(`${room.name} Total:`, 25, yPos);
                    doc.text(`${roomTotal.toFixed(0)}`, 160, yPos);
                    doc.setFont(undefined, 'normal');
                    yPos += 20;
                    
                    grandTotal += roomTotal;
                });
                
                // Grand total
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 40;
                }
                
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('PROJECT TOTAL:', 25, yPos);
                doc.text(`${grandTotal.toFixed(0)}`, 160, yPos);
                
                // Summary section
                yPos += 20;
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text('Summary:', 25, yPos);
                yPos += 15;
                doc.text(`Total Rooms: ${rooms.length}`, 30, yPos);
                yPos += 10;
                doc.text(`Price Book: ${activeBook?.name || 'Standard'}`, 30, yPos);
                yPos += 10;
                doc.text(`Labor Rate: ${laborRate}/hour`, 30, yPos);
                yPos += 10;
                doc.text(`Markup: ${markupPercent}%`, 30, yPos);
                
                doc.save(`${projectName.replace(/\s+/g, '_')}_detailed_quote.pdf`);
                alert('‚úÖ Detailed PDF quote generated and downloaded!');
            } catch (error) {
                alert('‚ùå Error generating PDF quote');
                console.error(error);
            }
        }

        // Show cost breakdown - Use modal instead of alert
        function showCostBreakdown() {
            if (rooms.length === 0) {
                alert('‚ùå Please add rooms to see cost breakdown');
                return;
            }
            
            const laborRate = parseFloat(document.getElementById('laborRate').value) || 85;
            const markupPercent = parseFloat(document.getElementById('markupPercent').value) || 25;
            const activeBook = priceBooks.find(book => book.active);
            const multiplier = activeBook ? activeBook.multiplier : 1.0;
            
            let breakdown = `<div class="max-h-96 overflow-y-auto">`;
            breakdown += `<h3 class="text-lg font-bold mb-4">Cost Breakdown (${activeBook?.name || 'Standard'})</h3>`;
            breakdown += `<div class="text-sm text-gray-600 mb-4">Labor Rate: ${laborRate}/hr | Markup: ${markupPercent}% | Price Book Multiplier: ${multiplier}x</div>`;
            
            let totalCost = 0;
            
            rooms.forEach(room => {
                breakdown += `<div class="mb-6 p-4 bg-gray-50 rounded-lg">`;
                breakdown += `<h4 class="font-semibold text-blue-900 mb-3">üìç ${room.name} (${room.area} sq ft)</h4>`;
                let roomTotal = 0;
                
                room.trades.forEach(trade => {
                    const items = activeBook?.items[trade] || [];
                    const avgCost = items.length > 0 ? 
                        items.reduce((sum, item) => sum + item.cost, 0) / items.length : 30;
                    
                    let cost = 0;
                    let description = '';
                    
                    switch(trade) {
                        case 'flooring':
                            cost = room.area * avgCost * multiplier;
                            description = `${room.area} sq ft √ó ${(avgCost * multiplier).toFixed(2)}`;
                            break;
                        case 'electrical':
                            cost = (room.area / 20) * avgCost * multiplier;
                            description = `${(room.area / 20).toFixed(1)} units √ó ${(avgCost * multiplier).toFixed(2)}`;
                            break;
                        case 'plumbing':
                            cost = (room.area / 50) * avgCost * multiplier;
                            description = `${(room.area / 50).toFixed(1)} units √ó ${(avgCost * multiplier).toFixed(2)}`;
                            break;
                        case 'hvac':
                            cost = (room.area / 30) * avgCost * multiplier;
                            description = `${(room.area / 30).toFixed(1)} units √ó ${(avgCost * multiplier).toFixed(2)}`;
                            break;
                        default:
                            cost = room.area * 5 * multiplier;
                            description = `${room.area} sq ft √ó ${(5 * multiplier).toFixed(2)}`;
                    }
                    
                    const laborHours = cost / 100;
                    const laborCost = laborHours * laborRate;
                    const totalTradeCost = (cost + laborCost) * (1 + markupPercent / 100);
                    
                    breakdown += `<div class="ml-4 mb-3 p-3 bg-white rounded border-l-4 border-blue-500">`;
                    breakdown += `<div class="font-medium text-gray-800 capitalize mb-2">${trade}</div>`;
                    breakdown += `<div class="text-sm space-y-1">`;
                    breakdown += `<div>Materials: ${description} = ${cost.toFixed(0)}</div>`;
                    breakdown += `<div>Labor: ${laborHours.toFixed(1)} hrs √ó ${laborRate} = ${laborCost.toFixed(0)}</div>`;
                    breakdown += `<div>Markup: ${markupPercent}% = ${(totalTradeCost - cost - laborCost).toFixed(0)}</div>`;
                    breakdown += `<div class="font-semibold text-blue-600 pt-2 border-t">Trade Total: ${totalTradeCost.toFixed(0)}</div>`;
                    breakdown += `</div></div>`;
                    
                    roomTotal += totalTradeCost;
                });
                
                breakdown += `<div class="font-bold text-lg text-blue-900 mt-4 pt-3 border-t border-blue-200">`;
                breakdown += `${room.name} Total: ${roomTotal.toFixed(0)}</div>`;
                breakdown += `</div>`;
                totalCost += roomTotal;
            });
            
            breakdown += `<div class="text-center p-4 bg-blue-50 rounded-lg mt-6">`;
            breakdown += `<div class="text-2xl font-bold text-blue-900">üí∞ PROJECT TOTAL: ${Math.round(totalCost).toLocaleString()}</div>`;
            breakdown += `<div class="text-sm text-blue-700 mt-2">(Matches main display: ${document.getElementById('totalCost').textContent})</div>`;
            breakdown += `</div></div>`;
            
            // Create and show modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-screen overflow-hidden">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold">üìä Detailed Cost Breakdown</h2>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">
                                &times;
                            </button>
                        </div>
                        ${breakdown}
                        <div class="mt-6 text-center">
                            <button onclick="this.closest('.fixed').remove()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Present to customer
        function presentToCustomer() {
            alert('üë• Customer presentation mode activated!\n\nThis would show a clean interface for customers to review and approve the quote.');
        }

        // Show room details
        function showRoomDetails() {
            if (rooms.length === 0) {
                alert('‚ùå No rooms to show details for');
                return;
            }
            
            let details = 'Room Details:\n\n';
            rooms.forEach(room => {
                details += `${room.name}: ${room.area} sq ft\n`;
                details += `Trades: ${room.trades.join(', ')}\n\n`;
            });
            alert(details);
        }

        // Save project
        function saveProject() {
            const projectData = {
                rooms: rooms,
                priceBooks: priceBooks,
                uploadedImage: uploadedImage,
                projectInfo: {
                    name: document.getElementById('projectName').value,
                    customer: document.getElementById('customerName').value,
                    address: document.getElementById('projectAddress').value
                }
            };
            
            localStorage.setItem('scopeProProject', JSON.stringify(projectData));
            alert('üíæ Project saved successfully!');
        }

        // Initialize
        function init() {
            updateCosts();
            updateRoomEditor();
            
            // Try to load saved project
            const savedData = localStorage.getItem('scopeProProject');
            if (savedData) {
                try {
                    const projectData = JSON.parse(savedData);
                    if (projectData.rooms) rooms = projectData.rooms;
                    if (projectData.priceBooks) priceBooks = projectData.priceBooks;
                    if (projectData.uploadedImage) uploadedImage = projectData.uploadedImage;
                    
                    if (projectData.projectInfo) {
                        document.getElementById('projectName').value = projectData.projectInfo.name || '';
                        document.getElementById('customerName').value = projectData.projectInfo.customer || '';
                        document.getElementById('projectAddress').value = projectData.projectInfo.address || '';
                    }
                    
                    updateRoomsList();
                    updateRoomEditor();
                    updateCosts();
                } catch (error) {
                    console.log('No saved project found');
                }
            }
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
